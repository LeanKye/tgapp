// Telegram Web App Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
class TelegramWebApp {
  constructor() {
    this.lastPageState = null; // Ð”Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
    this.init();
  }

  // Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð¾Ðµ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð³Ð»Ð°Ð²Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
  isMainPage() {
    const pathname = window.location.pathname;
    const href = window.location.href;
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð³Ð»Ð°Ð²Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
    return pathname === '/' || 
           pathname === '/index.html' || 
           pathname.endsWith('/index.html') ||
           pathname === '' ||
           href.includes('index.html') ||
           (!href.includes('product.html') && !href.includes('category.html'));
  }

  // ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ð¸ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
  setupNavigation(tg) {
    const isMain = this.isMainPage();
    
    // ÐžÑ‚Ð»Ð°Ð´Ð¾Ñ‡Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ
    console.log('ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹:', {
      pathname: window.location.pathname,
      href: window.location.href,
      isMain: isMain,
      lastState: this.lastPageState
    });
    
    // Ð—Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð´ÑƒÐ±Ð»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸
    if (this.lastPageState === isMain) {
      return;
    }
    
    this.lastPageState = isMain;
    
    if (isMain) {
      // ÐÐ° Ð³Ð»Ð°Ð²Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ðµ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÑƒ "ÐÐ°Ð·Ð°Ð´"
      tg.BackButton.hide();
      tg.MainButton.hide();
      
      // ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð²ÑÐµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ ÐºÐ½Ð¾Ð¿ÐºÐ¸ "ÐÐ°Ð·Ð°Ð´"
      tg.BackButton.offClick();
      
      // Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð»Ñ Ð³Ð»Ð°Ð²Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
      setTimeout(() => {
        tg.BackButton.hide();
        tg.MainButton.hide();
        console.log('ðŸ”„ ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°: ÐºÐ½Ð¾Ð¿ÐºÐ° "ÐÐ°Ð·Ð°Ð´" ÑÐºÑ€Ñ‹Ñ‚Ð° Ð½Ð° Ð³Ð»Ð°Ð²Ð½Ð¾Ð¹');
      }, 50);
      
      console.log('ðŸ  Ð“Ð»Ð°Ð²Ð½Ð°Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð°: ÐºÐ½Ð¾Ð¿ÐºÐ° "ÐÐ°Ð·Ð°Ð´" ÑÐºÑ€Ñ‹Ñ‚Ð°, ÑÑ‚Ð°Ñ‚ÑƒÑ:', tg.BackButton.isVisible);
    } else {
      // ÐÐ° Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð°Ñ… Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÑƒ "ÐÐ°Ð·Ð°Ð´"
      tg.MainButton.hide();
      tg.BackButton.show();
      
      // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹
      tg.BackButton.offClick();
      tg.BackButton.onClick(() => {
        if (document.referrer && document.referrer.includes(window.location.origin)) {
          window.history.back();
        } else {
          window.location.href = 'index.html';
        }
      });
      
      console.log('ðŸ“„ Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð°: ÐºÐ½Ð¾Ð¿ÐºÐ° "ÐÐ°Ð·Ð°Ð´" Ð¿Ð¾ÐºÐ°Ð·Ð°Ð½Ð°, ÑÑ‚Ð°Ñ‚ÑƒÑ:', tg.BackButton.isVisible);
    }
  }

  init() {
    // Ð–Ð´ÐµÐ¼ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Telegram WebApp SDK
    if (window.Telegram?.WebApp) {
      this.setupTelegramWebApp();
    } else {
      // Ð•ÑÐ»Ð¸ SDK ÐµÑ‰Ðµ Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½, Ð¶Ð´ÐµÐ¼
      window.addEventListener('load', () => {
        setTimeout(() => {
          this.setupTelegramWebApp();
        }, 100);
      });
    }
  }

  setupTelegramWebApp() {
    const tg = window.Telegram.WebApp;
    
    console.log('ðŸš€ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Telegram WebApp SDK');
    console.log('ðŸ“± Ð’ÐµÑ€ÑÐ¸Ñ SDK:', tg.version);
    console.log('ðŸŽ¨ Ð¦Ð²ÐµÑ‚Ð¾Ð²Ð°Ñ ÑÑ…ÐµÐ¼Ð°:', tg.colorScheme);
    
    // Ð Ð°ÑÑˆÐ¸Ñ€ÑÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ð° Ð²ÐµÑÑŒ ÑÐºÑ€Ð°Ð½
    tg.expand();
    
    // ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ ÑÐ²Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð¸ ÑÐ²Ð°Ð¹Ð¿Ðµ Ð²Ð½Ð¸Ð·
    tg.disableVerticalSwipes();
    
    // Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ
    tg.enableClosingConfirmation();
    
    // ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ†Ð²ÐµÑ‚Ð¾Ð²Ð¾Ð¹ ÑÑ…ÐµÐ¼Ñ‹
    tg.setHeaderColor('#000000');
    
    // ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÐºÐ½Ð¾Ð¿ÐºÐ¸ "ÐÐ°Ð·Ð°Ð´" Ð¸Ð»Ð¸ "Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"
    this.setupNavigation(tg);
    
    // Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¸Ðµ Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð»Ñ‹ Ð¿Ð¾ÑÐ»Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸
    setTimeout(() => this.setupNavigation(tg), 100);
    setTimeout(() => this.setupNavigation(tg), 300);
    setTimeout(() => this.setupNavigation(tg), 500);
    
    // ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°ÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÐºÐ½Ð¾Ð¿Ð¾Ðº
    window.addEventListener('popstate', () => {
      setTimeout(() => {
        this.setupNavigation(tg);
      }, 100);
    });

    // Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¸ Ñ„Ð¾ÐºÑƒÑÐµ Ð½Ð° Ð¾ÐºÐ½Ð¾
    window.addEventListener('focus', () => {
      setTimeout(() => {
        this.setupNavigation(tg);
      }, 100);
    });

    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
    window.addEventListener('load', () => {
      setTimeout(() => {
        this.setupNavigation(tg);
      }, 200);
    });

    // ÐŸÐµÑ€ÐµÑ…Ð²Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ URL Ð´Ð»Ñ SPA Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ð¸
    const originalPushState = history.pushState;
    const originalReplaceState = history.replaceState;
    
    history.pushState = function(...args) {
      originalPushState.apply(history, args);
      setTimeout(() => {
        this.setupNavigation(tg);
      }, 100);
    }.bind(this);
    
    history.replaceState = function(...args) {
      originalReplaceState.apply(history, args);
      setTimeout(() => {
        this.setupNavigation(tg);
      }, 100);
    }.bind(this);

    // ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ
    document.addEventListener('contextmenu', (e) => {
      e.preventDefault();
    });

    // ÐŸÑ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ drag and drop
    document.addEventListener('dragstart', (e) => {
      e.preventDefault();
    });

    // ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð²Ñ‹Ð´ÐµÐ»ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐºÑÑ‚Ð° Ð¿Ñ€Ð¸ Ð´Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¼ Ð½Ð°Ð¶Ð°Ñ‚Ð¸Ð¸
    document.addEventListener('selectstart', (e) => {
      if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
        e.preventDefault();
      }
    });
  }
}

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ
document.addEventListener('DOMContentLoaded', () => {
  new TelegramWebApp();
});
